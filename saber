#!/usr/bin/env php
<?php

use Symfony\Component\Console\Question\ConfirmationQuestion;
use Symfony\Component\Console\Question\ChoiceQuestion;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Input\InputInterface;
use Silly\Application;
use Illuminate\Container\Container;

use function Saber\success;
use function Saber\info;

if (file_exists(__DIR__ . '/../../autoload.php')) {
    require __DIR__ . '/../../autoload.php';
} else {
    require __DIR__ . '/vendor/autoload.php';
}

// Start the container
Container::setInstance(new Container());

// Version of App
$version = '1.1.1';

$app = new Application('Saber', $version);

/**
 * Installs Saber
 */
$app->command('install [--php=] [--db=]', function ($php = DEFAULT_PHP_VERSION, $db = DEFAULT_DATABASE_IMAGE) {
    // First, copy the .env.example file
    if (! File::fileExists('.env')) {
        File::copyFile('.env.example', '.env');
    }

    // Get the chosen PHP version
    Config::selectPhpVersion($php);

    // Get the chosen database version
    Config::selectDatabase($db);

    // Build the containers
    Docker::buildContainers();
})->descriptions('Installs Saber', [
    '--php' => 'Select the version of PHP you want installed',
    '--db' => 'Select which database you want installed.'
]);

/**
 * Uninstalls Saber
 */
$app->command('uninstall', function ($input, $output) {
    $helper = $this->getHelperSet()->get('question');

    $question = new ConfirmationQuestion('<fg=red;options=bold>Are you sure!? The application will be permenantly deleted [y]</>', false);

    if ($helper->ask($input, $output, $question)) {
        Docker::destroyContainers($input->getOption('verbose'));
    }
})->descriptions('Removes the containers generated by the Saber installation');

/**
 * Create a new application
 */
$app->command('new domain [-t|--tls]', function (string $domain, $tls, InputInterface $input) {

  // The TLD is added automatically, so no need to write it out yourself
    if (strpos($domain, '.')) {
        throw new Exception('A domain TLD is not required, this will be added automatically.');
    }

    // Add TLD to argument
    $domain = $domain . '.test';

    // If --tls option is enabled, certificates will be generated.
    if ($tls) {
        App::generateCertificate($domain);
    }

    // Generate new app configurations.
    $configFile = ($tls)
    ? SABER_HOME_CONFIG_PATH . '/lemp/nginx/config/conf.d/.default-tls.conf'
    : SABER_HOME_CONFIG_PATH . '/lemp/nginx/config/conf.d/.default-no_tls.conf';

    App::createNginxConfig($domain, $configFile);

    App::createPhpConfig($domain);

    Docker::restartContainers($input->getOption('verbose'));

    success('Application built and ready to use!');
})->descriptions('Creates a new development application environment', [
    'domain' => 'The name of your app',
    '--tls' => 'Add TLS certificates for your app'
]);

/**
 * Remove an application
 */
$app->command('remove domain', function (string $domain, InputInterface $input) {
    // The TLD is added automatically, so no need to write it out yourself
    if (strpos($domain, '.')) {
        throw new Exception('A domain TLD is not required, this will be added automatically.');
    }

    // Add TLD to argument
    $domain = $domain . '.test';

    // Remove all certificates
    App::removeCertificate($domain);

    // Remove NGINX configs
    App::removeNginxConfig($domain);

    // Remove PHP config
    App::removePhpConfig($domain);

    // Remove the app's code directory
    App::removeSiteCodeDirectory($domain);

    // Restart containers
    Docker::restartContainers($input->getOption('verbose'));
})->descriptions('Remove a development environment', [
    'domain' => 'The name of the app you want to remove'
]);

/**
 * Secure a non-secure site
 */
$app->command('secure domain', function (string $domain, InputInterface $input) {
    // Check if the site is already secure
    Secure::checkSecureStatus($domain);

    info('Securing site...');

    // Secure the site
    Secure::secure($domain);

    success('Site secured!');

    // Restart containers
    Docker::restartContainers($input->getOption('verbose'));
})->descriptions('Applies a certificate to the app', [
    'domain' => 'The name of the app your want to secure'
]);

/**
 * Make's a site unsecure
 */
$app->command('unsecure domain', function (string $domain, InputInterface $input) {
    // Check if the site exists
    Secure::checkSecureStatus($domain, true);

    info('Unsecuring site...');

    // Unsecure the site
    Secure::unsecure($domain);

    success('Site is now unsecure.');

    // Restart containers
    Docker::restartContainers($input->getOption('verbose'));
})->descriptions('Removes the certificate for the app', [
    'domain' => 'The name of the app your want to unsecure'
]);

/**
 * Switch PHP versions
 */
$app->command('use php-version [-f|--force]', function ($phpVersion, $force, InputInterface $input) {
    Config::selectPhpVersion($phpVersion, $force);

    Docker::buildContainers($input->getOption('verbose'));
})->descriptions('Switch PHP versions', [
    'php-version' => 'The version of PHP to switch to. Format: "7.3"',
    '--force' => 'Install un-supported versions of PHP'
]);

/**
 * Upgrade the containers
 */
$app->command('upgrade', function (InputInterface $input, OutputInterface $output) {
    $images = Docker::listImages();

    $helper = $this->getHelperSet()->get('question');

    $question = new ChoiceQuestion('Select images to upgrade. Select multiple by seperating with a commar, example: 1,3', $images);

    $question->setMultiselect(true);

    $answers = $helper->ask($input, $output, $question);

    Docker::upgradeImages($answers, $input->getOption('verbose'));
})->descriptions('Upgrade containers to their newest version');

$app->run();
